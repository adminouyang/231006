name: EPG

on:
  # 定时运行，例如每天16:00 UTC（即每天凌晨00:00上海时间）
  # schedule:
  #   - cron: '0 16 * * *'
  # 手动触发
  workflow_dispatch:

# 设置时区
env:
  TZ: 'Asia/Shanghai'

jobs:
  update-epg:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检查仓库代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: 运行EPG脚本
      id: run-epg
      run: |
        # 检查必要的配置文件是否存在
        if [ ! -f "epg.txt" ]; then
          echo "错误: epg.txt 文件不存在"
          exit 1
        fi
        
        if [ ! -f "demo.txt" ]; then
          echo "错误: demo.txt 文件不存在"
          exit 1
        fi
        
        if [ ! -f "py/TV/EPG/epg.py" ]; then
          echo "错误: py/TV/EPG/epg.py 文件不存在"
          exit 1
        fi
        
        # 显示配置文件内容
        echo "=== epg.txt 内容 ==="
        head -20 epg.txt
        echo ""
        
        echo "=== demo.txt 内容 ==="
        head -20 demo.txt
        echo ""
        
        # 运行EPG脚本
        echo "开始运行EPG脚本..."
        python py/TV/EPG/epg.py
        
        # 检查生成的epg.xml文件
        if [ -f "epg.xml" ]; then
          echo "✅ EPG文件生成成功"
          FILESIZE=$(stat -c%s "epg.xml")
          echo "文件大小: $((FILESIZE / 1024)) KB"
          
          # 统计频道数量
          CHANNEL_COUNT=$(grep -c '<channel id="' epg.xml || echo "0")
          echo "频道数量: $CHANNEL_COUNT"
          
          # 统计节目数量
          PROGRAM_COUNT=$(grep -c '<programme ' epg.xml || echo "0")
          echo "节目数量: $PROGRAM_COUNT"
          
          # 输出变量供后续步骤使用
          echo "channel_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          echo "program_count=$PROGRAM_COUNT" >> $GITHUB_OUTPUT
        else
          echo "❌ EPG文件生成失败"
          exit 1
        fi
    
    - name: 检查文件是否变化
      id: check-changes
      run: |
        echo "检查文件是否发生变化..."
        
        # 检查是否有未提交的更改
        git status
        
        # 检查是否有文件被修改
        if ! git diff --quiet HEAD -- epg.xml; then
          echo "epg.xml 文件已更新"
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "文件无变化"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: 提交更新的文件
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        echo "准备提交更新的文件..."
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # 检查当前git状态
        echo "当前git状态:"
        git status --porcelain
        
        # 只添加epg.xml文件
        git add epg.xml
        
        # 检查是否有要提交的更改
        if ! git diff --cached --quiet; then
          echo "提交更改..."
          git commit -m "自动更新epg.xml (频道: ${{ steps.run-epg.outputs.channel_count }}, 节目: ${{ steps.run-epg.outputs.program_count }})"
          git push
          echo "✅ 文件已成功提交到仓库"
        else
          echo "⚠ 没有需要提交的更改"
        fi
